============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
configfile: pyproject.toml
plugins: anyio-4.12.1
collecting ... collected 4 items

tests/test_sla_jobs.py::test_sla_lifecycle PASSED                        [ 25%]
tests/test_sla_jobs.py::test_sla_breach_and_escalation FAILED            [ 50%]
tests/test_sla_jobs.py::test_auto_close_job PASSED                       [ 75%]
tests/test_sla_jobs.py::test_reports_api PASSED                          [100%]

=================================== FAILURES ===================================
________________________ test_sla_breach_and_escalation ________________________

client = <starlette.testclient.TestClient object at 0x7ed10b39cdd0>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI4MzEsInN1YiI6IjVhM2MwZjY0LWEzMTQtNDNiMC1hZTljLTcxYzBiZDVmMTU5ZiJ9.PGoSofWIq1AAmxvJNVkdHHjp0iheThv09i8uZ-pd1JA'}
agent_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI4MzIsInN1YiI6IjY5ZmM5ZWU3LWI2M2QtNGQzYy05Nzc3LTEwZWVmODg3MmRjMSJ9.RtuJriRrHqezdtwRuppwNs_oGpa_6KtfPBYdbkZlX9o'}
customer_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI4MzIsInN1YiI6ImVlNGE3MTdlLTA1NGUtNGI0Zi1iMGQ5LTRmODY2OWRmOGU0OSJ9.55s_swdYFHWUyYxvqUMca_GsUAGvRgkQbv18Rj2q6bA'}
db = <sqlalchemy.orm.session.Session object at 0x7ed109fd4750>

    def test_sla_breach_and_escalation(client, admin_auth_headers, agent_auth_headers, customer_auth_headers, db: Session):
        # 1. Create Policy
        resp = client.post(
            "/api/v1/slas",
            headers=admin_auth_headers,
            json={
                "name": "Fast Support",
                "first_response_time_minutes": 10,
                "resolution_time_minutes": 30
            }
        )
        policy_id = resp.json()["data"]["id"]
    
        # 2. Create Ticket and Apply SLA
        resp = client.post(
            "/api/v1/tickets",
            headers=customer_auth_headers,
            json={"subject": "Breach Test", "description": "..."}
        )
        ticket_id = resp.json()["data"]["id"]
    
        client.post(
            f"/api/v1/slas/{policy_id}/apply",
            headers=agent_auth_headers,
            json={"ticket_id": ticket_id}
        )
    
        # 3. Fast Forward time to cause breach (20 mins later > 10 min first response)
        with freeze_time(datetime.now(timezone.utc) + timedelta(minutes=20)):
            # Run Job
>           sla_escalation_job()

tests/test_sla_jobs.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/jobs.py:89: in sla_escalation_job
    assign_history = Assignment(
<string>:4: in __init__
    ???
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.tickets.models.Assignment object at 0x7ed10b39fad0>
kwargs = {'assigned_agent_id': UUID('5a3c0f64-a314-43b0-ae9c-71c0bd5f159f'), 'ticket_id': UUID('a9a7fe3f-2e9a-4e7c-966e-4e0c596... 'user_id': UUID('5a3c0f64-a314-43b0-ae9c-71c0bd5f159f'), 'workspace_id': UUID('dc499682-27ce-4958-b84f-6396c30df796')}
cls_ = <class 'app.modules.tickets.models.Assignment'>, k = 'user_id'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'user_id' is an invalid keyword argument for Assignment

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:37:11,803 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:37:12,000 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
2026-01-07 18:37:12,394 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
2026-01-07 18:37:12,801 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2026-01-07 18:37:12,813 INFO httpx HTTP Request: POST http://testserver/api/v1/slas "HTTP/1.1 201 Created"
2026-01-07 18:37:12,825 INFO httpx HTTP Request: POST http://testserver/api/v1/tickets "HTTP/1.1 201 Created"
2026-01-07 18:37:12,842 INFO httpx HTTP Request: POST http://testserver/api/v1/slas/8c7efb22-9129-4488-a500-6536aa106adc/apply "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/slas "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/tickets "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/slas/8c7efb22-9129-4488-a500-6536aa106adc/apply "HTTP/1.1 200 OK"
=============================== warnings summary ===============================
tests/test_sla_jobs.py::test_sla_breach_and_escalation
  /app/app/jobs.py:57: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    ticket = db.query(Ticket).get(sla.ticket_id)

tests/test_sla_jobs.py::test_auto_close_job
  /app/tests/test_sla_jobs.py:119: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    ticket = db.query(Ticket).get(ticket_id)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_sla_jobs.py::test_sla_breach_and_escalation - TypeError: 'u...
=================== 1 failed, 3 passed, 2 warnings in 5.58s ====================
