============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
configfile: pyproject.toml
plugins: anyio-4.12.1
collecting ... collected 4 items

tests/test_sla_jobs.py::test_sla_lifecycle FAILED                        [ 25%]
tests/test_sla_jobs.py::test_sla_breach_and_escalation FAILED            [ 50%]
tests/test_sla_jobs.py::test_auto_close_job PASSED                       [ 75%]
tests/test_sla_jobs.py::test_reports_api FAILED                          [100%]

=================================== FAILURES ===================================
______________________________ test_sla_lifecycle ______________________________

client = <starlette.testclient.TestClient object at 0x7027e99ba5d0>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NDksInN1YiI6IjgzMDE2ZmYzLWFhOGYtNDM0ZC1iM2MxLTM2NjcyMjg1ZDBlZSJ9.C2F4ea_SsLiIAbKp1J9SJtsnrdLszySqHXQ_iccpieY'}
agent_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NDksInN1YiI6ImM3YmI2MWUwLTBmOGUtNDQ3ZS05ZjQyLWNhZTBhNjE5YmQ3YSJ9.fv5-Y7t0VcX5ddlliyXfL3UZCNEhb48b4GMK8pjs1s4'}
customer_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NTAsInN1YiI6IjM0Y2Q3ZjY4LTA2MTctNDE4OC1iN2VlLWViZjg4NDM4ODExNyJ9.5fbGOcY2mrn4VqVBXpqeDzvADRft1e8tJmMwoxshs1o'}
db = <sqlalchemy.orm.session.Session object at 0x7027e99dac90>

    def test_sla_lifecycle(client, admin_auth_headers, agent_auth_headers, customer_auth_headers, db: Session):
        # 1. Create SLA Policy (Admin)
        resp = client.post(
            "/api/v1/slas",
            headers=admin_auth_headers,
            json={
                "name": "Standard Support",
                "first_response_time_minutes": 60,
                "resolution_time_minutes": 240
            }
        )
        assert resp.status_code == 201
        policy_id = resp.json()["data"]["id"]
    
        # 2. Create Ticket (Customer)
        resp = client.post(
            "/api/v1/tickets",
            headers=customer_auth_headers,
            json={"subject": "Urgent Problem", "description": "Fix it"}
        )
        ticket_id = resp.json()["data"]["id"]
    
        # 3. Apply SLA (Agent)
>       resp = client.post(
            f"/api/v1/slas/{policy_id}/apply",
            headers=agent_auth_headers,
            json={"ticket_id": ticket_id}
        )

tests/test_sla_jobs.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1144: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:245: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/concurrency.py:32: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/to_thread.py:63: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:2502: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:986: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/sla/router.py:53: in apply_sla
    result = sla_service.apply_sla(db, ticket_id, policy_id, user)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.sla.service.SLAService object at 0x7027e8acab90>
db = <sqlalchemy.orm.session.Session object at 0x7027e99dac90>
ticket_id = UUID('56cf962f-7b0f-4ed2-8ca5-16b75965f03e')
policy_id = UUID('8972572a-f867-4a66-be1e-debc6b3159b4')
user = <app.modules.users.models.User object at 0x7027e7564f90>

    def apply_sla(self, db: Session, ticket_id: uuid.UUID, policy_id: uuid.UUID, user: User) -> TicketSLAResponse:
        # Agent/Admin
        policy = sla_repo.get_policy(db, policy_id, user.workspace_id)
        if not policy:
            raise NotFound(message="SLA Policy not found")
        if not policy.is_active:
            raise BadRequest(message="Cannot apply inactive policy")
    
>       ticket = ticket_repo.get(db, ticket_id, user.workspace_id) # Ensures existence and workspace
                 ^^^^^^^^^^^^^^^
E       AttributeError: 'TicketRepo' object has no attribute 'get'

app/modules/sla/service.py:42: AttributeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:35:49,209 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:35:49,417 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
2026-01-07 18:35:49,815 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
2026-01-07 18:35:50,216 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2026-01-07 18:35:50,242 INFO httpx HTTP Request: POST http://testserver/api/v1/slas "HTTP/1.1 201 Created"
2026-01-07 18:35:50,270 INFO httpx HTTP Request: POST http://testserver/api/v1/tickets "HTTP/1.1 201 Created"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/slas "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/tickets "HTTP/1.1 201 Created"
________________________ test_sla_breach_and_escalation ________________________

client = <starlette.testclient.TestClient object at 0x7027e89f5050>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NTEsInN1YiI6ImViZTgzY2U2LTE2NjMtNGYzOS1hNjk1LTM5NzVjMDllMjhkMCJ9.DUeypZTc9IdO3fPh1Fc3gCMmzz2rlGp57BAQ49J1Hjo'}
agent_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NTEsInN1YiI6ImFkMGU3YTE2LTdlODAtNDVhMS05OTUyLWY3ZGVhYTQ4YmRiZiJ9.Iiowom33mWe6DFaokfdojFAyLJDWwz9LgHYEjMogiNs'}
customer_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NTIsInN1YiI6IjA3Y2YwNjE5LWE3MjMtNDZlNS1hZmQ4LTA2N2E1YWMyYWRkMyJ9.W0nN-qm9CWM7Fjlz0BAAXkvYOgvwT7bU6Wtz0h2VlVY'}
db = <sqlalchemy.orm.session.Session object at 0x7027e8b06f50>

    def test_sla_breach_and_escalation(client, admin_auth_headers, agent_auth_headers, customer_auth_headers, db: Session):
        # 1. Create Policy
        resp = client.post(
            "/api/v1/slas",
            headers=admin_auth_headers,
            json={
                "name": "Fast Support",
                "first_response_time_minutes": 10,
                "resolution_time_minutes": 30
            }
        )
        policy_id = resp.json()["data"]["id"]
    
        # 2. Create Ticket and Apply SLA
        resp = client.post(
            "/api/v1/tickets",
            headers=customer_auth_headers,
            json={"subject": "Breach Test", "description": "..."}
        )
        ticket_id = resp.json()["data"]["id"]
    
>       client.post(
            f"/api/v1/slas/{policy_id}/apply",
            headers=agent_auth_headers,
            json={"ticket_id": ticket_id}
        )

tests/test_sla_jobs.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:546: in post
    return super().post(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1144: in post
    return self.request(
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:445: in request
    return super().request(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/usr/local/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:348: in handle_request
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/usr/local/lib/python3.11/site-packages/anyio/from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:355: in app
    raw_response = await run_endpoint_function(
/usr/local/lib/python3.11/site-packages/fastapi/routing.py:245: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/starlette/concurrency.py:32: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/to_thread.py:63: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:2502: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py:986: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
app/modules/sla/router.py:53: in apply_sla
    result = sla_service.apply_sla(db, ticket_id, policy_id, user)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.sla.service.SLAService object at 0x7027e8acab90>
db = <sqlalchemy.orm.session.Session object at 0x7027e8b06f50>
ticket_id = UUID('f5ddf540-955e-448f-84b0-2ceb75393e43')
policy_id = UUID('e988d97e-af1a-4717-a7f7-fad747141332')
user = <app.modules.users.models.User object at 0x7027e6a22c50>

    def apply_sla(self, db: Session, ticket_id: uuid.UUID, policy_id: uuid.UUID, user: User) -> TicketSLAResponse:
        # Agent/Admin
        policy = sla_repo.get_policy(db, policy_id, user.workspace_id)
        if not policy:
            raise NotFound(message="SLA Policy not found")
        if not policy.is_active:
            raise BadRequest(message="Cannot apply inactive policy")
    
>       ticket = ticket_repo.get(db, ticket_id, user.workspace_id) # Ensures existence and workspace
                 ^^^^^^^^^^^^^^^
E       AttributeError: 'TicketRepo' object has no attribute 'get'

app/modules/sla/service.py:42: AttributeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:35:51,283 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:35:51,479 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
2026-01-07 18:35:51,872 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
2026-01-07 18:35:52,271 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
2026-01-07 18:35:52,282 INFO httpx HTTP Request: POST http://testserver/api/v1/slas "HTTP/1.1 201 Created"
2026-01-07 18:35:52,292 INFO httpx HTTP Request: POST http://testserver/api/v1/tickets "HTTP/1.1 201 Created"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/slas "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/tickets "HTTP/1.1 201 Created"
_______________________________ test_reports_api _______________________________

self = <sqlalchemy.engine.base.Connection object at 0x7027e70fa490>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7027e8b9c210>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7027e70f8b90>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7027e70f8bd0>
parameters = [{'assigned_agent_id': None, 'channel': 'WEB', 'closed_at': None, 'created_at': datetime.datetime(2026, 1, 7, 18, 35, 54, 474139, tzinfo=datetime.timezone.utc), ...}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <psycopg.Cursor [closed] [IDLE] (host=postgres database=helpdesk) at 0x7027e89c0b40>
query = 'INSERT INTO tickets (id, workspace_id, created_by_user_id, subject, description, status, priority, channel, assigned_...MESTAMP WITH TIME ZONE, %(last_agent_activity_at)s::TIMESTAMP WITH TIME ZONE, %(closed_at)s::TIMESTAMP WITH TIME ZONE)'
params = {'assigned_agent_id': None, 'channel': 'WEB', 'closed_at': None, 'created_at': datetime.datetime(2026, 1, 7, 18, 35, 54, 474139, tzinfo=datetime.timezone.utc), ...}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.ForeignKeyViolation: insert or update on table "tickets" violates foreign key constraint "tickets_created_by_user_id_fkey"
E           DETAIL:  Key (created_by_user_id)=(2aa99979-ce6d-403f-af5d-91bb4491464d) is not present in table "users".

/usr/local/lib/python3.11/site-packages/psycopg/cursor.py:117: ForeignKeyViolation

The above exception was the direct cause of the following exception:

client = <starlette.testclient.TestClient object at 0x7027e6ca4a90>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTI3NTQsInN1YiI6IjIyMDQ3ODQzLTYzODAtNGJkOC1iODQwLTBmMWUxYzU4NWFlYSJ9.M2WJmXnHLFmlgdrkOILI0uQ6ZL1qB6IfDZmWvYf7tJc'}
db = <sqlalchemy.orm.session.Session object at 0x7027e6f73950>

    def test_reports_api(client, admin_auth_headers, db: Session):
        # Ensure some data exists (from previous tests or create new)
        # We can rely on isolation or create new. conftest usually isolates per test func?
        # db fixture truncates? Yes.
    
        # Create manually for report
        from app.modules.workspaces.models import Workspace
        ws = db.query(Workspace).first()
    
        # 1 created, 0 resolved
        t = Ticket(workspace_id=ws.id, subject="Report T", description=".", created_by_user_id=ws.id) # Admin created
        db.add(t)
>       db.commit()

tests/test_sla_jobs.py:140: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.11/site-packages/sqlalchemy/sql/elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/default.py:952: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <psycopg.Cursor [closed] [IDLE] (host=postgres database=helpdesk) at 0x7027e89c0b40>
query = 'INSERT INTO tickets (id, workspace_id, created_by_user_id, subject, description, status, priority, channel, assigned_...MESTAMP WITH TIME ZONE, %(last_agent_activity_at)s::TIMESTAMP WITH TIME ZONE, %(closed_at)s::TIMESTAMP WITH TIME ZONE)'
params = {'assigned_agent_id': None, 'channel': 'WEB', 'closed_at': None, 'created_at': datetime.datetime(2026, 1, 7, 18, 35, 54, 474139, tzinfo=datetime.timezone.utc), ...}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) insert or update on table "tickets" violates foreign key constraint "tickets_created_by_user_id_fkey"
E           DETAIL:  Key (created_by_user_id)=(2aa99979-ce6d-403f-af5d-91bb4491464d) is not present in table "users".
E           [SQL: INSERT INTO tickets (id, workspace_id, created_by_user_id, subject, description, status, priority, channel, assigned_agent_id, created_at, updated_at, last_customer_activity_at, last_agent_activity_at, closed_at) VALUES (%(id)s::UUID, %(workspace_id)s::UUID, %(created_by_user_id)s::UUID, %(subject)s::VARCHAR, %(description)s::VARCHAR, %(status)s, %(priority)s, %(channel)s, %(assigned_agent_id)s::UUID, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE, %(last_customer_activity_at)s::TIMESTAMP WITH TIME ZONE, %(last_agent_activity_at)s::TIMESTAMP WITH TIME ZONE, %(closed_at)s::TIMESTAMP WITH TIME ZONE)]
E           [parameters: {'id': UUID('f51db4e7-3331-4e31-9d42-ba19dc8a0410'), 'workspace_id': UUID('2aa99979-ce6d-403f-af5d-91bb4491464d'), 'created_by_user_id': UUID('2aa99979-ce6d-403f-af5d-91bb4491464d'), 'subject': 'Report T', 'description': '.', 'status': 'NEW', 'priority': 'MEDIUM', 'channel': 'WEB', 'assigned_agent_id': None, 'created_at': datetime.datetime(2026, 1, 7, 18, 35, 54, 474139, tzinfo=datetime.timezone.utc), 'updated_at': datetime.datetime(2026, 1, 7, 18, 35, 54, 474142, tzinfo=datetime.timezone.utc), 'last_customer_activity_at': None, 'last_agent_activity_at': None, 'closed_at': None}]
E           (Background on this error at: https://sqlalche.me/e/20/gkpj)

/usr/local/lib/python3.11/site-packages/psycopg/cursor.py:117: IntegrityError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:35:54,275 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:35:54,471 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
=============================== warnings summary ===============================
tests/test_sla_jobs.py::test_auto_close_job
  /app/tests/test_sla_jobs.py:118: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    ticket = db.query(Ticket).get(ticket_id)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_sla_jobs.py::test_sla_lifecycle - AttributeError: 'TicketRe...
FAILED tests/test_sla_jobs.py::test_sla_breach_and_escalation - AttributeErro...
FAILED tests/test_sla_jobs.py::test_reports_api - sqlalchemy.exc.IntegrityErr...
==================== 3 failed, 1 passed, 1 warning in 6.35s ====================
