============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.11
cachedir: .pytest_cache
rootdir: /app
configfile: pyproject.toml
plugins: anyio-4.12.1
collecting ... collected 6 items

tests/test_tickets.py::test_customer_can_create_and_list_own_tickets ERROR [ 16%]
tests/test_tickets.py::test_customer_cannot_access_other_users_ticket ERROR [ 33%]
tests/test_tickets.py::test_agent_can_list_workspace_tickets ERROR       [ 50%]
tests/test_tickets.py::test_agent_can_assign_ticket_and_msg ERROR        [ 66%]
tests/test_tickets.py::test_internal_notes_visibility ERROR              [ 83%]
tests/test_tickets.py::test_tags_operations ERROR                        [100%]

==================================== ERRORS ====================================
_______ ERROR at setup of test_customer_can_create_and_list_own_tickets ________

client = <starlette.testclient.TestClient object at 0x754717ff4a50>
db = <sqlalchemy.orm.session.Session object at 0x754716ce6c90>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTE5MzgsInN1YiI6ImZiZTkyMTJiLTAzZjEtNDI0Mi05YTA0LWU3OTRjOWQyYTRiNiJ9.5Kx9K8JktN9ZTRSKzoPt6qW63ziD0zVCM0wGewgc04E'}

    @pytest.fixture
    def customer_auth_headers(client, db, admin_auth_headers):
        # Get workspace id
        admin = db.query(User).filter(User.email == "admin@test.com").first()
        workspace_id = admin.workspace_id
    
>       customer = User(
            email="customer@test.com",
            hashed_password=get_password_hash("password"),
            full_name="Customer",
            role=Role.CUSTOMER,
            workspace_id=workspace_id,
            is_active=True
        )

tests/conftest.py:129: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.users.models.User object at 0x754717ba1510>
kwargs = {'email': 'customer@test.com', 'full_name': 'Customer', 'hashed_password': '$2b$12$aUKMXwcvK7cEh6Z3gzHx1umDPmuVjqfGwffCG/aeT.57NMqrVQZAW', 'is_active': True, ...}
cls_ = <class 'app.modules.users.models.User'>, k = 'hashed_password'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'hashed_password' is an invalid keyword argument for User

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:22:18,507 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:22:18,715 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
_______ ERROR at setup of test_customer_cannot_access_other_users_ticket _______

client = <starlette.testclient.TestClient object at 0x754717b68950>
db = <sqlalchemy.orm.session.Session object at 0x754717b68990>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTE5MzksInN1YiI6IjY4OGZmN2Q5LTQwM2MtNDhlMi04NGFmLTA4NzVlNDBlMzVjOSJ9.ud7mWtlfKszzf5JqDXPrBv2wxClM1k78-oWaGAgAB5k'}

    @pytest.fixture
    def customer_auth_headers(client, db, admin_auth_headers):
        # Get workspace id
        admin = db.query(User).filter(User.email == "admin@test.com").first()
        workspace_id = admin.workspace_id
    
>       customer = User(
            email="customer@test.com",
            hashed_password=get_password_hash("password"),
            full_name="Customer",
            role=Role.CUSTOMER,
            workspace_id=workspace_id,
            is_active=True
        )

tests/conftest.py:129: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.users.models.User object at 0x7547159bc910>
kwargs = {'email': 'customer@test.com', 'full_name': 'Customer', 'hashed_password': '$2b$12$tl8hrFbb9ymqGN6MmLzG2uGJb.Veeo8eRjCYbnD08e7fu39srH2Z6', 'is_active': True, ...}
cls_ = <class 'app.modules.users.models.User'>, k = 'hashed_password'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'hashed_password' is an invalid keyword argument for User

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:22:19,605 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:22:19,804 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
___________ ERROR at setup of test_agent_can_list_workspace_tickets ____________

client = <starlette.testclient.TestClient object at 0x7547187da750>
db = <sqlalchemy.orm.session.Session object at 0x754715bed490>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTE5NDAsInN1YiI6Ijk0YmEzMGMyLWEyNGQtNGNmZS1hNWQxLTk1NWQwYWVmMDQ3MyJ9.b1iP-UcDrOW5DQOnh_s1RVz5-wdRCI9FGQ8TXbKerwk'}

    @pytest.fixture
    def agent_auth_headers(client, db, admin_auth_headers):
        # Get workspace id from admin (who we know exists now)
        # Or just query DB
        admin = db.query(User).filter(User.email == "admin@test.com").first()
        workspace_id = admin.workspace_id
    
>       agent = User(
            email="agent@test.com",
            hashed_password=get_password_hash("password"),
            full_name="Agent",
            role=Role.AGENT,
            workspace_id=workspace_id,
            is_active=True
        )

tests/conftest.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.users.models.User object at 0x754715c87d50>
kwargs = {'email': 'agent@test.com', 'full_name': 'Agent', 'hashed_password': '$2b$12$oYfi9iuJ3.6R.dsG3tJAb.bIk7cewNV6x075ZNqGg70vnx1WDpRM6', 'is_active': True, ...}
cls_ = <class 'app.modules.users.models.User'>, k = 'hashed_password'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'hashed_password' is an invalid keyword argument for User

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:22:20,405 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:22:20,603 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
____________ ERROR at setup of test_agent_can_assign_ticket_and_msg ____________

client = <starlette.testclient.TestClient object at 0x754715c07fd0>
db = <sqlalchemy.orm.session.Session object at 0x754715bed4d0>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTE5NDEsInN1YiI6IjAyNTRmYTVmLTQwZjMtNGQ0ZS1hMTcxLThlNDdkNzNkMmUzMyJ9.uZBgKrDb6K0HLFgbDxH8MyKMTeif4Y8FmghCyT2cUyk'}

    @pytest.fixture
    def agent_auth_headers(client, db, admin_auth_headers):
        # Get workspace id from admin (who we know exists now)
        # Or just query DB
        admin = db.query(User).filter(User.email == "admin@test.com").first()
        workspace_id = admin.workspace_id
    
>       agent = User(
            email="agent@test.com",
            hashed_password=get_password_hash("password"),
            full_name="Agent",
            role=Role.AGENT,
            workspace_id=workspace_id,
            is_active=True
        )

tests/conftest.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.users.models.User object at 0x754715c12750>
kwargs = {'email': 'agent@test.com', 'full_name': 'Agent', 'hashed_password': '$2b$12$syfYfHHlW78PI1zy/Xjr/uAeg8UrnbFpDWwr7QLLYgA/urZL0DZzW', 'is_active': True, ...}
cls_ = <class 'app.modules.users.models.User'>, k = 'hashed_password'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'hashed_password' is an invalid keyword argument for User

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:22:21,161 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:22:21,358 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
_______________ ERROR at setup of test_internal_notes_visibility _______________

client = <starlette.testclient.TestClient object at 0x754716ce8d10>
db = <sqlalchemy.orm.session.Session object at 0x754716ce8310>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTE5NDIsInN1YiI6IjYyZTRkYjE4LWYyM2YtNGZiNy1iNTc0LTA2YmU4NGNlNGRhYiJ9.GPeeiKZaSGpCIAjOS3IkTB9V_eZUqUE2joF28atejZg'}

    @pytest.fixture
    def agent_auth_headers(client, db, admin_auth_headers):
        # Get workspace id from admin (who we know exists now)
        # Or just query DB
        admin = db.query(User).filter(User.email == "admin@test.com").first()
        workspace_id = admin.workspace_id
    
>       agent = User(
            email="agent@test.com",
            hashed_password=get_password_hash("password"),
            full_name="Agent",
            role=Role.AGENT,
            workspace_id=workspace_id,
            is_active=True
        )

tests/conftest.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.users.models.User object at 0x754715adb810>
kwargs = {'email': 'agent@test.com', 'full_name': 'Agent', 'hashed_password': '$2b$12$HSOJN1ybrQMSUgztKaswyeeJyjDZDo9BZqXdrpZrD07FMWqs8BS1C', 'is_active': True, ...}
cls_ = <class 'app.modules.users.models.User'>, k = 'hashed_password'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'hashed_password' is an invalid keyword argument for User

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:22:21,902 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:22:22,099 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
____________________ ERROR at setup of test_tags_operations ____________________

client = <starlette.testclient.TestClient object at 0x754715c08b10>
db = <sqlalchemy.orm.session.Session object at 0x754717bb4250>
admin_auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Njc4MTE5NDIsInN1YiI6IjUxNDMzOTgxLTJiZTEtNDA5YS04ZDU5LWQwYzAzYzRlMzg3NCJ9.Sur-hhupIYmKxHNzH4MTCNqw8F2iPu7Tyq3GX8qlH1Q'}

    @pytest.fixture
    def agent_auth_headers(client, db, admin_auth_headers):
        # Get workspace id from admin (who we know exists now)
        # Or just query DB
        admin = db.query(User).filter(User.email == "admin@test.com").first()
        workspace_id = admin.workspace_id
    
>       agent = User(
            email="agent@test.com",
            hashed_password=get_password_hash("password"),
            full_name="Agent",
            role=Role.AGENT,
            workspace_id=workspace_id,
            is_active=True
        )

tests/conftest.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:596: in _initialize_instance
    with util.safe_reraise():
/usr/local/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.modules.users.models.User object at 0x754715a38f50>
kwargs = {'email': 'agent@test.com', 'full_name': 'Agent', 'hashed_password': '$2b$12$m6WL7vafpdgAxbVL0yJW7ehjActV.b.wMtQFjQK3JBUs32wWVdlHO', 'is_active': True, ...}
cls_ = <class 'app.modules.users.models.User'>, k = 'hashed_password'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'hashed_password' is an invalid keyword argument for User

/usr/local/lib/python3.11/site-packages/sqlalchemy/orm/decl_base.py:2179: TypeError
---------------------------- Captured stdout setup -----------------------------
2026-01-07 18:22:22,685 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
2026-01-07 18:22:22,882 INFO httpx HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/register "HTTP/1.1 201 Created"
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/auth/login "HTTP/1.1 200 OK"
=========================== short test summary info ============================
ERROR tests/test_tickets.py::test_customer_can_create_and_list_own_tickets - ...
ERROR tests/test_tickets.py::test_customer_cannot_access_other_users_ticket
ERROR tests/test_tickets.py::test_agent_can_list_workspace_tickets - TypeErro...
ERROR tests/test_tickets.py::test_agent_can_assign_ticket_and_msg - TypeError...
ERROR tests/test_tickets.py::test_internal_notes_visibility - TypeError: 'has...
ERROR tests/test_tickets.py::test_tags_operations - TypeError: 'hashed_passwo...
============================== 6 errors in 5.22s ===============================
